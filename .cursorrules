# Project Rules: Database & Migrations

## 1. Database Schema Updates
- **NEVER** use `prisma db push` for production-critical changes or deployment scripts. It does not track history and can cause data loss.
- **ALWAYS** use `prisma migrate dev --name <descriptive_name>` locally to generate migration files.
- **ALWAYS** commit the `prisma/migrations` folder to Git.
- **DEPLOYMENT**: The build pipeline (Vercel) uses `prisma migrate deploy` in the `postbuild` script.

## 2. Vercel & automated Deployments
- The `package.json` must include:
  ```json
  "postbuild": "prisma generate && prisma migrate deploy"
  ```
- The Vercel Build Command must be set to `npm run build` (so it triggers `postbuild`).
- DO NOT set Vercel Build Command to `next build` directly, as it skips migrations.

## 3. Supabase & Connection Pooling
- **DATABASE_URL**: Must be the **Transaction Pooler** (Port 6543) for the application runtime.
- **DIRECT_URL**: Must be the **Session Pooler** (Port 5432) for migrations.
- **Credential Format**: When using `pooler.supabase.com`, the username **MUST** include the project reference:
  - Format: `postgres.[project-ref]` (e.g. `postgres.abcdefg`)
  - NEVER use just `postgres` with the pooler host.

## 4. Frontend Build
- Use `next build --webpack` in `package.json` if Turbopack has issues with PostCSS/Autoprefixer.
