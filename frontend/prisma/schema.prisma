generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  slug      String   @unique // URL-friendly identifier
  settings  Json     @default("{}")

  members    OrganizationMember[]
  connectors Connector[]
  documents  Document[]

  @@map("organizations")
}

model OrganizationMember {
  id             String     @id @default(cuid())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  organizationId String
  userId         String // Supabase user ID
  role           MemberRole @default(OWNER)
  isDefault      Boolean    @default(false) // Primary org for this user

  // User profile (denormalized for performance)
  email       String
  firstName   String?
  lastName    String?
  displayName String?
  avatarUrl   String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([userId, isDefault])
  @@map("organization_members")
}

model Connector {
  id              String          @id @default(cuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  organizationId  String
  type            ConnectorType   @default(GOOGLE_DRIVE)
  googleAccountId String
  email           String
  name            String?
  avatarUrl       String?
  accessToken     String
  refreshToken    String?
  tokenExpiresAt  DateTime?
  status          ConnectorStatus @default(ACTIVE)
  lastSyncAt      DateTime?
  settings        Json            @default("{}")
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents       Document[]

  @@unique([organizationId, googleAccountId])
  @@map("connectors")
}

model Document {
  id             String         @id @default(cuid())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId String
  connectorId    String?
  externalId     String
  title          String
  mimeType       String
  fileSize       BigInt?
  webViewLink    String?
  content        String?
  summary        String?
  tags           String[]       @default([])
  metadata       Json           @default("{}")
  status         DocumentStatus @default(PROCESSING)
  lastModifiedAt DateTime?
  connector      Connector?     @relation(fields: [connectorId], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, externalId])
  @@map("documents")
}

enum ConnectorType {
  GOOGLE_DRIVE
  GOOGLE_CALENDAR
  GOOGLE_TASKS
  DROPBOX
  ONEDRIVE
  BOX
  NOTION
  CONFLUENCE
}

enum ConnectorStatus {
  ACTIVE
  EXPIRED
  REVOKED
  ERROR
}

enum DocumentStatus {
  PROCESSING
  PROCESSED
  ERROR
  ARCHIVED
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

model ContactSubmission {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")
  ipAddress      String?  @map("ip_address")
  email          String?
  plan           String?
  role           String?
  teamSize       String?  @map("team_size")
  painPoint      String?  @map("pain_point")
  featureRequest String?  @map("feature_request")
  comments       String?

  @@index([ipAddress, createdAt])
  @@map("contact_submissions")
}
