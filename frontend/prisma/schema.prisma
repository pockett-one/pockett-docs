generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  slug      String   @unique // URL-friendly identifier
  settings  Json     @default("{}")

  // Billing Fields
  stripeCustomerId   String?
  subscriptionStatus String?   @default("none") // active, trialing, past_due, canceled, unpaid, none

  members    OrganizationMember[]
  connectors Connector[]
  documents  Document[]
  clients    Client[]
  projects   Project[]
  personas   ProjectPersona[]

  @@map("organizations")
}

model Client {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String   @db.Uuid
  name           String
  slug           String
  
  // Optional business fields
  industry       String?
  sector         String?

  status         String   @default("ACTIVE")
  settings       Json     @default("{}")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@map("clients")
}

model Project {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  organizationId String   @db.Uuid
  clientId      String   @db.Uuid // Required: Project must belong to a Client
  name          String
  slug          String
  description   String?
  driveFolderId String?  // ID of the Google Drive folder
  settings      Json     @default("{}")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  documents    Document[]
  members      ProjectMember[]
  invitations  ProjectInvitation[]

  @@unique([clientId, slug])
  @@index([organizationId])
  @@index([clientId])
  @@map("projects")
}

model OrganizationMember {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  organizationId String     @db.Uuid
  userId         String     @db.Uuid // Supabase user ID is UUID
  roleId         String     @db.Uuid
  isDefault      Boolean    @default(false) // Primary org for this user

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([userId, isDefault])
  @@map("organization_members")
}

model Role {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @unique
  displayLabel String
  description  String?
  createdBy    String?  @db.Uuid
  updatedBy    String?  @db.Uuid
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organizationMembers OrganizationMember[]
  projectPersonas     ProjectPersona[]

  @@map("roles")
}

model Permission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  displayLabel String   @unique
  name         String   @unique
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("role_permissions")
}

model Connector {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  organizationId  String          @db.Uuid
  type            ConnectorType   @default(GOOGLE_DRIVE)
  googleAccountId String
  email           String
  name            String?
  avatarUrl       String?
  accessToken     String
  refreshToken    String?
  tokenExpiresAt  DateTime?
  status          ConnectorStatus @default(ACTIVE)
  lastSyncAt      DateTime?
  settings        Json            @default("{}")
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents       Document[]
  linkedFiles     LinkedFile[]

  @@unique([organizationId, googleAccountId])
  @@map("connectors")
}

model Document {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId String         @db.Uuid
  connectorId    String?        @db.Uuid
  externalId     String
  title          String
  mimeType       String
  fileSize       BigInt?
  webViewLink    String?
  content        String?
  summary        String?
  tags           String[]       @default([])
  metadata       Json           @default("{}")
  status         DocumentStatus @default(PROCESSING)
  lastModifiedAt DateTime?
  connector      Connector?     @relation(fields: [connectorId], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectId      String?        @db.Uuid
  project        Project?       @relation(fields: [projectId], references: [id])

  @@unique([organizationId, externalId])
  @@map("documents")
}

model ProjectMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  projectId String   @db.Uuid
  userId    String   @db.Uuid // Supabase user ID

  // Link to Persona
  personaId String?  @db.Uuid
  settings  Json     @default("{}")

  project Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  persona ProjectPersona? @relation(fields: [personaId], references: [id])

  @@unique([projectId, userId])
  @@index([userId])
  @@map("project_members")
}

model ProjectPersona {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  organizationId String     @db.Uuid
  name           String
  description    String?
  roleId         String     @db.Uuid
  permissions    Json       @default("{}") 
  isDefault      Boolean    @default(false)

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         Role            @relation(fields: [roleId], references: [id])
  members      ProjectMember[]
  invitations  ProjectInvitation[]

  @@map("project_personas")
}

model ProjectInvitation {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  projectId      String           @db.Uuid
  email          String
  personaId      String           @db.Uuid
  status         InvitationStatus @default(PENDING)
  token          String           @unique
  expireAt       DateTime?
  acceptedAt     DateTime?
  joinedAt       DateTime?

  project Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  persona ProjectPersona @relation(fields: [personaId], references: [id])

  @@unique([projectId, email])
  @@map("project_invitations")
}

model LinkedFile {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  connectorId    String   @db.Uuid
  fileId         String
  metadata       Json     @default("{}")
  isGrantRevoked Boolean  @default(false) @map("is_grant_revoked")
  linkedAt       DateTime @default(now())

  connector   Connector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  @@unique([connectorId, fileId])
  @@map("linked_files")
}

model ContactSubmission {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")
  ipAddress      String?  @map("ip_address")
  email          String?
  plan           String?
  role           String?
  teamSize       String?  @map("team_size")
  painPoint      String?  @map("pain_point")
  featureRequest String?  @map("feature_request")
  comments       String?

  @@map("contact_submissions")
}

enum ConnectorType {
  GOOGLE_DRIVE
  GOOGLE_CALENDAR
  GOOGLE_TASKS
  DROPBOX
  ONEDRIVE
  BOX
  NOTION
  CONFLUENCE
}

enum ConnectorStatus {
  ACTIVE
  EXPIRED
  REVOKED
  ERROR
}

enum DocumentStatus {
  PROCESSING
  PROCESSED
  ERROR
  ARCHIVED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  JOINED
  EXPIRED
}
